{% extends 'base.html.twig' %}

{% block title %}Ticket #{{ ticket.id }} — Mini GLPI{% endblock %}

{% block body %}

{#
    Le data-controller="status" englobe tout le bloc.
    Les targets (badge, start, close, modify, error) peuvent être
    n'importe où à l'intérieur de cet élément.
#}
<div data-controller="status"
     data-status-url-value="{{ path('ticket_status', {id: ticket.id}) }}"
     data-status-token-value="{{ csrf_token('ticket_status_' ~ ticket.id) }}">

{# Flash messages #}
{% for message in app.flashes('success') %}
    <div class="mb-4 bg-green-50 border border-green-200 text-green-700 text-sm rounded-lg px-4 py-3">{{ message }}</div>
{% endfor %}
{% for message in app.flashes('error') %}
    <div class="mb-4 bg-red-50 border border-red-200 text-red-700 text-sm rounded-lg px-4 py-3">{{ message }}</div>
{% endfor %}

<div class="mb-6 flex items-center justify-between flex-wrap gap-3">
    <div>
        <a href="{{ path('ticket_list') }}" class="text-sm text-gray-500 hover:text-gray-700">← Retour à la liste</a>
        <h1 class="text-2xl font-bold text-gray-900 mt-2">Ticket #{{ ticket.id }}</h1>
    </div>

    <div class="flex gap-2 items-center flex-wrap">

        {# Zone d'erreur AJAX #}
        <span data-status-target="error"
              class="hidden text-xs font-medium text-red-700 bg-red-50 border border-red-200 rounded-lg px-3 py-2"></span>

        {# Lien Modifier — masqué dès que le statut passe à CLOSED #}
        <a href="{{ path('ticket_edit', {id: ticket.id}) }}"
           data-status-target="modify"
           class="text-sm px-4 py-2 rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50 transition
                  {{ ticket.status.value == 'closed' ? 'hidden' : '' }}">
            Modifier
        </a>

        {# Bouton Démarrer — visible uniquement si OPEN #}
        <button type="button"
                data-status-target="start"
                data-action="click->status#start"
                class="text-sm px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white transition
                       {{ ticket.status.value != 'open' ? 'hidden' : '' }}">
            Démarrer la prise en charge
        </button>

        {# Bouton Fermer — visible si pas déjà CLOSED #}
        <button type="button"
                data-status-target="close"
                data-action="click->status#close"
                class="text-sm px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white transition
                       {{ ticket.status.value == 'closed' ? 'hidden' : '' }}">
            Fermer
        </button>

    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    {# Détail principal #}
    <div class="lg:col-span-2 space-y-6">

        <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-1">{{ ticket.title }}</h2>
            <p class="text-sm text-gray-400 mb-4">
                Créé le {{ ticket.createdAt|date('d/m/Y à H:i') }}
                par <span class="font-medium text-gray-600">{{ ticket.createdBy.userIdentifier }}</span>
            </p>
            <div class="text-sm text-gray-700 leading-relaxed whitespace-pre-line">
                {{ ticket.description }}
            </div>
        </div>

    </div>

    {# Panneau latéral #}
    <div class="space-y-4">

        {# Statut & priorité #}
        <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-5">
            <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">Informations</h3>

            <dl class="space-y-3 text-sm">
                <div class="flex justify-between items-center">
                    <dt class="text-gray-500">Statut</dt>
                    <dd>
                        {# Badge mis à jour dynamiquement par le contrôleur Stimulus #}
                        <span data-status-target="badge"
                              class="inline-flex px-2.5 py-0.5 rounded-full text-xs font-medium
                                     {% if ticket.status.value == 'open' %}bg-yellow-100 text-yellow-800
                                     {% elseif ticket.status.value == 'in_progress' %}bg-blue-100 text-blue-800
                                     {% else %}bg-gray-100 text-gray-600{% endif %}">
                            {% if ticket.status.value == 'open' %}Ouvert
                            {% elseif ticket.status.value == 'in_progress' %}En cours
                            {% else %}Fermé{% endif %}
                        </span>
                    </dd>
                </div>
                <div class="flex justify-between items-center">
                    <dt class="text-gray-500">Priorité</dt>
                    <dd class="font-medium text-gray-700">
                        {% if ticket.priority == 'CRITICAL' %}
                            <span class="text-red-600 font-semibold">Critique</span>
                        {% elseif ticket.priority == 'HIGH' %}
                            <span class="text-orange-500 font-semibold">Haute</span>
                        {% elseif ticket.priority == 'MEDIUM' %}
                            <span class="text-yellow-600">Moyenne</span>
                        {% else %}
                            <span class="text-gray-500">Basse</span>
                        {% endif %}
                    </dd>
                </div>
                <div class="flex justify-between items-center">
                    <dt class="text-gray-500">Assigné à</dt>
                    <dd class="font-medium text-gray-700">
                        {{ ticket.assignedTo ? ticket.assignedTo.userIdentifier : '—' }}
                    </dd>
                </div>
            </dl>
        </div>

        {# Assignation (ROLE_TECH uniquement) #}
        {% if is_granted('ROLE_TECH') and ticket.assignedTo is null and ticket.status.value != 'closed' %}
        <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-5">
            <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">Assigner le ticket</h3>
            <form action="{{ path('ticket_assign', {id: ticket.id}) }}" method="post">
                <select name="user_id"
                        class="w-full px-3 py-2 rounded-lg border border-gray-300 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3">
                    {% for tech in techs %}
                        <option value="{{ tech.id }}">{{ tech.userIdentifier }}</option>
                    {% endfor %}
                </select>
                <button type="submit"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 rounded-lg transition">
                    Assigner
                </button>
            </form>
        </div>
        {% endif %}

    </div>
</div>

</div>{# /data-controller="status" #}

{% endblock %}
